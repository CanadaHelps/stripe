CRM.$(function(d){var n;var b;var c;var a;var m=false;function s(y){f("paymentIntent confirmation success");var x=document.createElement("input");x.setAttribute("type","hidden");x.setAttribute("name","paymentIntentID");x.setAttribute("value",y.id);c.appendChild(x);c.submit()}function g(x){f("error: "+x.error.message);var y=document.getElementById("card-errors");y.style.display="block";y.textContent=x.error.message;document.querySelector("#billing-payment-block").scrollIntoView();window.scrollBy(0,-50);a.removeAttribute("disabled")}function v(){f("handle card payment");n.createPaymentMethod("card",b).then(function(x){if(x.error){g(x)}else{var y=CRM.url("civicrm/stripe/confirm-payment");d.post(y,{payment_method_id:x.paymentMethod.id,amount:o(),currency:CRM.vars.stripe.currency,id:CRM.vars.stripe.id}).then(function(z){t(z)})}})}function t(x){f("handleServerResponse");if(x.error){g(x)}else{if(x.requires_action){p(x)}else{s(x.paymentIntent)}}}function p(x){n.handleCardAction(x.payment_intent_client_secret).then(function(y){if(y.error){g(y)}else{s(y.paymentIntent)}})}var l=null;d(document).ready(function(){window.onbeforeunload=null;j();d("select#payment_processor_id").on("change",function(){d("input.payproc-metadata").remove()})});d(document).ajaxComplete(function(y,A,x){if((x.url.match("civicrm(/|%2F)payment(/|%2F)form")!=null)||(x.url.match("civicrm(/|%2F)contact(/|%2F)view(/|%2F)participant")!=null)){if(d("#payment_processor_id").length>0){var z=d("#payment_processor_id").val();if(z!=CRM.vars.stripe.id){f("payment processor changed to id: "+z);CRM.api3("PaymentProcessorType","getvalue",{sequential:1,"return":"id",name:"Stripe"}).done(function(B){var C=B.result;CRM.api3("PaymentProcessor","getvalue",{sequential:1,"return":"password",id:z,payment_processor_type_id:C}).done(function(D){var E=D.result;if(E){f("Setting new stripe key to: "+E);CRM.vars.stripe.publishableKey=E}else{f("New payment processor is not Stripe, setting stripe-pub-key to null");CRM.vars.stripe.publishableKey=null}j()})})}}j()}});function j(){if(typeof CRM.vars.stripe==="undefined"){f("CRM.vars.stripe not defined!");return}if(typeof Stripe==="undefined"){if(m){return}m=true;f("Stripe.js is not loaded!");d.getScript("https://js.stripe.com/v3",function(){f("Script loaded and executed.");m=false;e()})}else{e()}}function e(){n=Stripe(CRM.vars.stripe.publishableKey);var B=n.elements();var z={base:{fontSize:"20px"}};b=B.create("card",{style:z});b.mount("#card-element");document.getElementsByClassName("billing_postal_code-"+CRM.vars.stripe.billingAddressID+"-section")[0].setAttribute("hidden",true);b.addEventListener("change",function(C){r(C)});c=h();if(typeof c.length==="undefined"||c.length===0){f("No billing form!");return}a=w();c.dataset.submitdontprocess=false;var x=c.querySelectorAll('[type="submit"][formnovalidate="1"], [type="submit"][formnovalidate="formnovalidate"], [type="submit"].cancel, [type="submit"].webform-previous'),y;for(y=0;y<x.length;++y){x[y].addEventListener("click",function(){f("adding submitdontprocess");c.dataset.submitdontprocess=true})}a.addEventListener("click",function(C){f("clearing submitdontprocess");c.dataset.submitdontprocess=false;return A(C)});a.removeAttribute("onclick");k();if(u()){d("[type=submit]").click(function(){q(this.value)});c.addEventListener("keydown",function(C){if(C.keyCode===13){q(this.value);A(event)}});d("#billingcheckbox:input").hide();d('label[for="billingcheckbox"]').hide()}function A(E){E.preventDefault();f("submit handler");if(c.dataset.submitted===true){f("form already submitted");return false}var G;var D;if(typeof CRM.vars.stripe!=="undefined"){G=CRM.vars.stripe.id}if(u()){G=CRM.vars.stripe.id;if(!d('input[name="submitted[civicrm_1_contribution_1_contribution_payment_processor_id]"]').length){D=G}else{D=c.querySelector('input[name="submitted[civicrm_1_contribution_1_contribution_payment_processor_id]"]:checked').val()}}else{if((c.querySelector(".crm-section.payment_processor-section")!==null)||(c.querySelector(".crm-section.credit_card_info-section")!==null)){G=CRM.vars.stripe.id;if(c.querySelector('input[name="payment_processor_id"]:checked')!==null){D=c.querySelector('input[name="payment_processor_id"]:checked').value}}}if((D===0)||(G==null)||((D==null)&&(G==null))){f("Not a Stripe transaction, or pay-later");return true}else{f("Stripe is the selected payprocessor")}if(typeof CRM.vars.stripe.publishableKey==="undefined"){f("submit missing stripe-pub-key element or value");return true}if(c.dataset.submitdontprocess===true){f("non-payment submit detected - not submitting payment");return true}if(u()){if(d("#billing-payment-block").is(":hidden")){f("no payment processor on webform");return true}var F=d('[name="submitted[civicrm_1_contribution_1_contribution_payment_processor_id]"]');if(F.length){if(F.filter(":checked").val()==="0"||F.filter(":checked").val()===0){f("no payment processor selected");return true}}}var C=o();if(C=="0"){f("Total amount is 0");return true}if(c.dataset.submitted===true){alert("Form already submitted. Please wait.");return false}else{c.dataset.submitted=true}a.setAttribute("disabled",true);v();return true}}function u(){if(c!==null){return c.classList.contains("webform-client-form")||c.classList.contains("webform-submission-form")}return false}function h(){var x=d("div#card-element").closest("form").prop("id");if(!x.length){x=d("input[name=hidden_processor]").closest("form").prop("id")}return document.getElementById(x)}function w(){var x=null;if(u()){x=c.querySelector('[type="submit"].webform-submit');if(!x){x=c.querySelector('[type="submit"].webform-button--submit')}}else{x=c.querySelector('[type="submit"].validate')}return x}function o(){var x=null;if(typeof calculateTotalFee=="function"){x=calculateTotalFee()}else{if(u()){d(".line-item:visible","#wf-crm-billing-items").each(function(){x+=parseFloat(d(this).data("amount"))})}}return x}function r(x){if(!x.complete){return}document.getElementById("billing_postal_code-"+CRM.vars.stripe.billingAddressID).value=x.value.postalCode}function k(){cividiscountElements=c.querySelectorAll("input#discountcode");for(i=0;i<cividiscountElements.length;++i){cividiscountElements[i].addEventListener("keydown",function(x){if(x.keyCode===13){x.preventDefault();f("adding submitdontprocess");c.dataset.submitdontprocess=true}})}}function f(x){if((typeof(CRM.vars.stripe)==="undefined")||(Boolean(CRM.vars.stripe.jsDebug)===true)){console.log(new Date().toISOString()+" civicrm_stripe.js: "+x)}}function q(y){var x=null;if(document.getElementById("action")!==null){x=document.getElementById("action")}else{x=document.createElement("input")}x.setAttribute("type","hidden");x.setAttribute("name","op");x.setAttribute("id","action");x.setAttribute("value",y);c.appendChild(x)}});